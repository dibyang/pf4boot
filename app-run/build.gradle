plugins {
    id "nebula.ospackage" version "8.4.1"
    id 'java-library'
}

build {
    enabled = false
}
jar {
    enabled = false
}
install {
    enabled = false
}
uploadArchives {
    enabled = false
}

dependencies {
    api project(":demo-app")
    plugin project(":plugin1")
    plugin project(":plugin2")
}

ext.packname='demo-app'

task prepackage(type: Copy)  {
    group 'build'
    copy
    {
        from("./package-scripts/"){
            include('*.sh')
            filter(org.apache.tools.ant.filters.ReplaceTokens, tokens: [app_name:packname])
        }
        into "$buildDir/ready"
    }
}

ospackage {
    packageName = "$packname"
    epoch= 1
    release = '1'
    os = LINUX
    user = 'root'
    conflicts("$packname")
    prepackage
    into "/$packname"

    from("bin"){
        into "bin"
        fileMode = 0555
        filter(org.apache.tools.ant.filters.ReplaceTokens, tokens: [app_name:packname])
    }

    from("config-prod"){
        fileType CONFIG | NOREPLACE
        into "config"
    }

    from(configurations.runtime){
        into "lib"
        exclude '*-sources.jar','*-javadoc.jar','spring-boot-devtools*.jar'
    }

    from("plugins"){
        into "plugins"
        include "disabled.txt"
    }

    from(configurations.plugin){
        into "plugins"
        include "*.zip"
    }

}

buildRpm {
    group 'build'
    link("/etc/init.d/$packname", "/$packname/bin/init.sh")
    preInstall file("$buildDir/ready/preInstallCentos.sh")
    postInstall file("$buildDir/ready/postInstallCentos.sh")
    preUninstall file("$buildDir/ready/preUninstallCentos.sh")
}


task buildOSPacks(dependsOn:[buildRpm]){
    group 'build'
}